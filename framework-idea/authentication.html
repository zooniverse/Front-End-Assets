<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>Zooniverse Authentication</title>
  </head>

  <body>
    <script>
      var $ = parent.require('jQuery');

      var host = 'https://login.zooniverse.org';
      if (+location.port !== 80) host = '//' + location.host;

      function issueCommand(command, params) {
        var url = host + '/' + command + '?callback=?';
        var request = $.getJSON(url, params);

        request.done(function(response) {
          postBack(command, response);
        });

        request.fail(function(response) {
          if (command === 'current_user') return;
          postBack(command, {success: false, message: 'Couldn\'t connect to the server'});
        });
      }

      function postBack(command, response) {
        parent.postMessage({command: command, response: response}, location.protocol + '//' + location.host);
      }

      $(window).on('message', function(e) {
        // console.info('Message to auth', e.originalEvent);

        var commands = e.originalEvent.data;
        for (var command in commands) {
          issueCommand(command, commands[command]);
        }
      });

      issueCommand('current_user', {});
    </script>
  </body>
</html>
